{% extends "base.html" %}
{% block content %}

<style>
  .case-header-card{
    border:0;
    border-radius:1rem;
    box-shadow:0 8px 24px rgba(15,23,42,.08);
    background:linear-gradient(135deg,#ffffff,#f8fafc);
  }
  .badge-case-type{
    padding:.25rem .6rem;
    border-radius:999px;
    font-size:.75rem;
    font-weight:600;
  }
  .badge-case-type.goods{ background:#ecfdf5; color:#047857; }
  .badge-case-type.remit{ background:#eff6ff; color:#1d4ed8; }

  .pill-state{
    padding:.25rem .7rem;
    border-radius:999px;
    font-size:.75rem;
    font-weight:600;
    background:#e5e7eb;
    color:#374151;
  }
  .pill-state.NUEVO{ background:#e0f2fe; color:#0369a1; }
  .pill-state.EN_PROCESO{ background:#fef3c7; color:#92400e; }
  .pill-state.COMPLETADO{ background:#dcfce7; color:#166534; }
  .pill-state.CANCELADO{ background:#fee2e2; color:#b91c1c; }

  .label-soft{
    font-size:.75rem;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:#94a3b8;
  }

  .summary-box{
    border-radius:.75rem;
    background:#f8fafc;
    padding:.75rem 1rem;
    border:1px dashed #e2e8f0;
  }

  .timeline{
    border-left:2px solid #e5e7eb;
    margin-left:.5rem;
    padding-left:1rem;
  }
  .timeline-item{
    position:relative;
    margin-bottom:.75rem;
  }
  .timeline-item::before{
    content:"";
    position:absolute;
    left:-1.05rem;
    top:.3rem;
    width:.6rem;
    height:.6rem;
    border-radius:999px;
    background:#0f766e;
    box-shadow:0 0 0 3px #ecfdf5;
  }
  .timeline-time{
    font-size:.75rem;
    color:#6b7280;
  }
  .timeline-state{
    font-weight:600;
    font-size:.85rem;
  }

  .chip-attachment-kind{
    display:inline-block;
    padding:.15rem .5rem;
    border-radius:999px;
    font-size:.7rem;
    background:#eff6ff;
    color:#1d4ed8;
  }

  .small-muted{
    font-size:.8rem;
    color:#6b7280;
  }

  .table-items thead{
    background:#f1f5f9;
  }
  .table-items th{
    font-size:.75rem;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:#64748b;
  }

  .flag-pill{
    display:inline-flex;
    align-items:center;
    gap:.25rem;
    padding:.1rem .45rem;
    border-radius:999px;
    background:#e5e7eb;
    font-size:.8rem;
  }
  .flag-pill img.flag-icon{
    width:18px;
    height:12px;
    border-radius:2px;
    object-fit:cover;
    box-shadow:0 0 0 1px rgba(15,23,42,.15);
  }

  /* Inputs peque√±os para items */
  .table-items input.form-control-sm{
    padding:.1rem .35rem;
    height: calc(1.5em + .5rem + 2px);
    font-size:.8rem;
  }
</style>

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <div class="label-soft mb-1">Detalle de caso</div>
    <h3 class="mb-1">
      {{ c.title or 'Caso sin t√≠tulo' }}
    </h3>
    <div class="d-flex flex-wrap align-items-center gap-2">
      {% set kind = (c.case_type or c.type or '') %}
      <span class="badge-case-type {% if kind=='GOODS' %}goods{% else %}remit{% endif %}">
        {{ kind }}
      </span>

      <span class="pill-state {{ c.state }}" id="lbl-state">
        {{ c.state }}
      </span>

      <span class="small-muted">
        C√≥digo: <strong>{{ c.code }}</strong>
      </span>

      <span class="small-muted">
        Creado: {{ c.created_at[:10] if c.created_at }}
      </span>
      {% if c.updated_at %}
        <span class="small-muted">
          ¬∑ Actualizado: {{ c.updated_at[:10] }}
        </span>
      {% endif %}
    </div>
  </div>

  
</div>


<div class="row g-3">

  <!-- Columna izquierda -->
  <div class="col-lg-8">

    <!-- Resumen principal -->
    <div class="card case-header-card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="label-soft mb-1">Cliente</div>
            {% if c.customer %}
              <div class="fw-semibold">{{ c.customer.name }}</div>
              <div class="small-muted">
                üìß {{ c.customer.email or 'Sin email' }} ¬∑ üì± {{ c.customer.phone or 'Sin tel√©fono' }}
              </div>
            {% else %}
              <div class="small-muted">Sin datos de cliente</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <div class="label-soft mb-1">Contacto adicional</div>
            {% if c.contact %}
              <div class="fw-semibold">
                {{ c.contact.name }}
                {% if c.contact.relation %}
                  <span class="text-muted small">({{ c.contact.relation }})</span>
                {% endif %}
              </div>
              <div class="small-muted">
                üìß {{ c.contact.email or 'Sin email' }} ¬∑ üì± {{ c.contact.phone or 'Sin tel√©fono' }}
              </div>
            {% else %}
              <div class="small-muted">Sin contacto asociado</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen -->
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
      <span>Resumen</span>
      <div class="d-flex align-items-center gap-2">
        {% if c.meta and c.meta.notify %}
          <span class="small-muted">Notificaci√≥n: {{ c.meta.notify }}</span>
        {% endif %}

        <button class="btn btn-sm btn-outline-primary" id="btn-advance">
          Cambiar estado
        </button>
        <button class="btn btn-sm btn-primary" id="btn-save-meta">
          ‚úèÔ∏è Editar
        </button>
        
  
      </div>
    </div>


      
      <div class="card-body">

        {% set meta = c.meta or {} %}
        {% set kind = meta.kind or c.case_type or c.type %}

        {% if kind == 'GOODS' %}
          {# ================== GOODS ================== #}

          {# 3.1 ‚Äì Origen ‚Äì Destino #}
          <div class="summary-box mb-3">
            <div class="label-soft mb-1">Origen ‚Äì Destino</div>

            {% set orig_country = 'US' %}
            {% set dest_country = 'PY' %}

            {% set orig_flag_file = 'img/flags/us.svg' %}
            {% if orig_country == 'PY' %}
              {% set orig_flag_file = 'img/flags/py.svg' %}
            {% endif %}

            {% set dest_flag_file = 'img/flags/py.svg' %}
            {% if dest_country == 'US' %}
              {% set dest_flag_file = 'img/flags/us.svg' %}
            {% endif %}

            <div class="fw-semibold mb-1 d-flex align-items-center gap-2">
              <span class="flag-pill">
                <img src="{{ url_for('static', filename=orig_flag_file) }}"
                     alt="{{ orig_country }}" class="flag-icon">
                {{ orig_country }}
              </span>
              <span class="mx-1">‚Üí</span>
              <span class="flag-pill">
                <img src="{{ url_for('static', filename=dest_flag_file) }}"
                     alt="{{ dest_country }}" class="flag-icon">
                {{ dest_country }}
              </span>
            </div>
          </div>

          {# 3.2 ‚Äì Tabla de √≠tems (editable) #}
                    <div class="mb-3">
            <div class="label-soft mb-1">Items</div>
            {% if meta.goods and 'items' in meta.goods %}
              <div class="summary-box p-0">
                <div class="table-responsive">
                  <table class="table table-sm table-items mb-0 align-middle">
                    <thead>
                      <tr>
                        <th>Producto</th>
                        <th class="text-end">Cant.</th>
                        <th class="text-end">Costo USD</th>
                        <th class="text-end">Precio USD</th>
                      </tr>
                    </thead>
                    <tbody id="goods-items-body">
                      {% for it in meta.goods['items'] %}
                        <tr data-index="{{ loop.index0 }}">
                          <td>
                            <span class="view-only">{{ it.description }}</span>
                            <input class="form-control form-control-sm edit-only d-none in-desc"
                                   value="{{ it.description }}" disabled>
                          </td>
                          <td class="text-end">
                            <span class="view-only">{{ it.qty }}</span>
                            <input type="number"
                                   min="1"
                                   class="form-control form-control-sm edit-only d-none in-qty"
                                   value="{{ it.qty }}">
                          </td>
                          <td class="text-end">
                            <span class="view-only">{{ it.cost_usd|numfmt(2) }}</span>
                            <input type="number"
                                   step="0.01"
                                   class="form-control form-control-sm edit-only d-none in-cost"
                                   value="{{ '%.2f'|format(it.cost_usd) }}">
                          </td>
                          <td class="text-end">
                            <span class="view-only">{{ it.price_usd|numfmt(2) }}</span>
                            <input type="number"
                                   step="0.01"
                                   class="form-control form-control-sm edit-only d-none in-price"
                                   value="{{ '%.2f'|format(it.price_usd) }}"
                                   disabled>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% else %}
              <div class="summary-box">
                <div class="small-muted">Sin items cargados.</div>
              </div>
            {% endif %}
          </div>

          {# 3.3 ‚Äì Totales + Fee editable #}
          <div class="mb-2">
            <div class="label-soft mb-1">Totales</div>
            <div class="summary-box">
              {% if meta.fx %}
                <hr class="my-2">
                <div class="small-muted">
                  Cotizaci√≥n {{ meta.fx.pair }} @ {{ meta.fx.rate|numfmt(0) }} ({{ meta.fx.date }})
                </div>
              {% endif %}
                <hr class="my-2">

              {% if meta.amounts %}
                <div class="row g-2">
                  <div class="col-md-6">
                    <div class="small-muted mb-1 fw-semibold">En USD</div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Base:</span>
                      <span id="tot-base-usd">{{ meta.amounts.base.usd|numfmt(2) }}</span>
                    </div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Fee:</span>
                      <span id="tot-fee-usd">{{ meta.amounts.fee.usd|numfmt(2) }}</span>
                    </div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Total:</span>
                      <span id="tot-total-usd">{{ meta.amounts.total.usd|numfmt(2) }}</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="small-muted mb-1 fw-semibold">En Gs</div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Base:</span>
                      <span id="tot-base-pyg">{{ meta.amounts.base.pyg|numfmt(0) }}</span>
                    </div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Fee:</span>
                      <span id="tot-fee-pyg">{{ meta.amounts.fee.pyg|numfmt(0) }}</span>
                    </div>
                    <div class="d-flex justify-content-between small-muted">
                      <span>Total:</span>
                      <span id="tot-total-pyg">{{ meta.amounts.total.pyg|numfmt(0) }}</span>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if meta.goods and meta.goods.shipping %}
                <hr class="my-2">
                <div class="d-flex justify-content-between small-muted">
                  <span>Shipping:</span>
                  <span>
                    {{ meta.goods.shipping.amount|numfmt(2) }}
                    {{ meta.goods.shipping.currency }}
                    ¬∑ {{ 'Incluido' if meta.goods.shipping.enabled else 'No incluido' }}
                  </span>
                </div>
              {% endif %}


              {# Fee editable #}
              <hr class="my-2">
              
              <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="label-soft mb-1">Fee</div>

            {# Vista solo lectura #}
            <div class="view-only small-muted" id="fee-view-label">
              Modo: <strong>{{ meta.fee_mode or 'PCT' }}</strong>
            </div>

            {# Controles de edici√≥n: solo tipo, valor viene de /config/api/pricing #}
            <div class="edit-only d-none">
              <div class="row g-2 align-items-center">
                <div class="col-6">
                  <select id="sel-fee-mode" class="form-select form-select-sm">
                    {# Uso FIX para mantener consistencia con create_wizard #}
                    <option value="NONE" {% if meta.fee_mode == 'NONE' %}selected{% endif %}>Sin fee</option>
                    <option value="PCT"  {% if meta.fee_mode == 'PCT' or not meta.fee_mode %}selected{% endif %}>Porcentaje (%)</option>
                    <option value="FIX"  {% if meta.fee_mode == 'FIX' %}selected{% endif %}>Monto fijo USD</option>
                  </select>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-sm">
                    <span class="input-group-text" id="lbl-fee-unit">%</span>
                    <input type="number"
                           step="0.01"
                           class="form-control text-end"
                           id="inp-fee-value"
                           value="0.0"
                           disabled>
                  </div>
                  
                </div>
              </div>
            </div>
          </div>

        </div>

        <hr>
        
            </div>
          </div>

          {# Notas (editable) #}
          <hr>
          
          <div class="mb-2" style="min-width:260px;">
            <div class="label-soft mb-1">Notas</div>

            <!-- Modo solo lectura -->
            <div class="view-only small-muted" id="notes-view">
              {{ meta.notes or 'Sin notas' }}
            </div>

            <!-- Modo edici√≥n -->
            <textarea id="txt-notes"
                      class="form-control form-control-sm edit-only d-none"
                      rows="2"
                      placeholder="Notas internas o comentarios...">{{ meta.notes or '' }}</textarea>
          </div>
          
                {% else %}
          {# ================== REMIT ================== #}

          {# 1) Remitente / Destinatario lado a lado #}
          <div class="row g-3 mb-3 align-items-center">
            <!-- Remitente -->
            <div class="col-md-5">
              <div class="summary-box h-100">
                <div class="label-soft mb-1">Remitente</div>

                {% if meta.sender %}
                  {% set sender_country = meta.sender.country or 'US' %}
                  {% set sender_flag_file = 'img/flags/us.svg' %}
                  {% if sender_country == 'PY' %}
                    {% set sender_flag_file = 'img/flags/py.svg' %}
                  {% endif %}

                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-semibold">{{ meta.sender.name }}</div>
                    <span class="flag-pill">
                      <img src="{{ url_for('static', filename=sender_flag_file) }}"
                          alt="{{ sender_country }}" class="flag-icon">
                      {{ sender_country }}
                    </span>
                  </div>
                  <div class="small-muted">
                    üì± {{ meta.sender.phone }}{% if meta.sender.country %} ¬∑ üåé {{ meta.sender.country }}{% endif %}
                  </div>
                {% else %}
                  <div class="small-muted">Sin datos de remitente.</div>
                {% endif %}
              </div>
            </div>

            <!-- Flecha centro -->
            <div class="col-md-2 d-flex justify-content-center">
              <img src="{{ url_for('static', filename='img/right-arrow-full.svg') }}"
                  alt="‚Üí"
                  style="width:75px; opacity:0.7;">
            </div>

            <!-- Destinatario -->
            <div class="col-md-5">
              <div class="summary-box h-100">
                <div class="label-soft mb-1">Destinatario</div>

                {% if meta.receiver %}
                  {% set receiver_country = meta.receiver.country or 'PY' %}
                  {% set receiver_flag_file = 'img/flags/py.svg' %}
                  {% if receiver_country == 'US' %}
                    {% set receiver_flag_file = 'img/flags/us.svg' %}
                  {% endif %}

                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-semibold">{{ meta.receiver.name }}</div>
                    <span class="flag-pill">
                      <img src="{{ url_for('static', filename=receiver_flag_file) }}"
                          alt="{{ receiver_country }}" class="flag-icon">
                      {{ receiver_country }}
                    </span>
                  </div>
                  <div class="small-muted">
                    üì± {{ meta.receiver.phone }}{% if meta.receiver.country %} ¬∑ üåé {{ meta.receiver.country }}{% endif %}
                  </div>
                {% else %}
                  <div class="small-muted">Sin datos de destinatario.</div>
                {% endif %}
              </div>
            </div>
          </div>


          {# 2) Montos (card a lo ancho) #}
          <div class="summary-box mb-3">
            <div class="label-soft mb-1">Montos</div>

            <div class="small-muted">Monto enviado (USD)</div>
            <div class="fw-semibold fs-5 mb-2" id="remit-amount-view">
              {{ (meta.remit.amount_usd if meta.remit and meta.remit.amount_usd is not none
                  else (meta.amounts.base.usd if meta.amounts and meta.amounts.base else 0))|numfmt(2) }}
            </div>

            <div class="edit-only d-none mb-2" style="max-width:240px;">
              <input id="remit-amount-edit" type="number" step="0.01"
                     class="form-control form-control-sm"
                     value="{{ meta.remit.amount_usd if meta.remit and meta.remit.amount_usd is not none
                               else (meta.amounts.base.usd if meta.amounts and meta.amounts.base else 0) }}">
            </div>

            {% if meta.amounts %}
              <div class="row g-2">
                <div class="col-md-6">
                  <div class="small-muted mb-1 fw-semibold">En PY</div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Base PY:</span>
                    <span id="remit-base-pyg">{{ meta.amounts.base.pyg|numfmt(0) }}</span>
                  </div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Fee PY:</span>
                    <span id="remit-fee-pyg">{{ meta.amounts.fee.pyg|numfmt(0) }}</span>
                  </div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Total PY:</span>
                    <span id="remit-total-pyg">{{ meta.amounts.total.pyg|numfmt(0) }}</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="small-muted mb-1 fw-semibold">En USD (calculado)</div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Base USD:</span>
                    <span>
                      {{ (meta.amounts.base.usd if meta.amounts and meta.amounts.base and meta.amounts.base.usd is not none
                          else (meta.remit.amount_usd if meta.remit and meta.remit.amount_usd is not none else 0))|numfmt(2) }}
                    </span>
                  </div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Fee USD:</span>
                    <span>
                      {{ (meta.amounts.fee.usd if meta.amounts and meta.amounts.fee and meta.amounts.fee.usd is not none
                          else 0)|numfmt(2) }}
                    </span>
                  </div>
                  <div class="d-flex justify-content-between small-muted">
                    <span>Total USD:</span>
                    <span>
                      {{ (meta.amounts.total.usd if meta.amounts and meta.amounts.total and meta.amounts.total.usd is not none
                          else 0)|numfmt(2) }}
                    </span>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>

          {# 3) FX (cotizaci√≥n) & Fee (con selector igual a GOODS) #}
          <div class="summary-box mb-3">
            <div class="row g-3 align-items-start">
              <div class="col-md-6">
                <div class="label-soft mb-1">FX</div>
                {% if meta.fx %}
                  <div class="small-muted">
                    Par: <span id="remit-fx-pair">{{ meta.fx.pair }}</span>
                    ¬∑ Fecha: <span id="remit-fx-date">{{ meta.fx.date }}</span>
                  </div>
                  <div class="small-muted">
                    Tasa: <strong id="remit-fx-rate">{{ meta.fx.rate|numfmt(0) }}</strong>
                  </div>
                {% else %}
                  <div class="small-muted">Sin cotizaci√≥n guardada.</div>
                {% endif %}
              </div>

              <div class="col-md-6">
                <div class="label-soft mb-1">Fee</div>

                {# Vista solo lectura #}
                <div class="view-only small-muted" id="fee-view-label">
                  Modo: <strong>{{ meta.fee_mode or 'PCT' }}</strong>
                </div>

                {# Controles de edici√≥n: s√≥lo tipo, valor viene de /config/api/pricing #}
                <div class="edit-only d-none">
                  <div class="row g-2 align-items-center">
                    <div class="col-6">
                      <select id="sel-fee-mode" class="form-select form-select-sm">
                        <option value="NONE" {% if meta.fee_mode == 'NONE' %}selected{% endif %}>Sin fee</option>
                        <option value="PCT"  {% if meta.fee_mode == 'PCT' or not meta.fee_mode %}selected{% endif %}>
                          Porcentaje (%)
                        </option>
                        <option value="FIX"  {% if meta.fee_mode == 'FIX' %}selected{% endif %}>
                          Monto fijo USD
                        </option>
                      </select>
                    </div>
                    <div class="col-6">
                      <div class="input-group input-group-sm">
                        <span class="input-group-text" id="lbl-fee-unit">%</span>
                        <input type="number"
                               step="0.01"
                               class="form-control text-end"
                               id="inp-fee-value"
                               value="0.00"
                               disabled>
                      </div>
                    </div>
                  </div>
                  <div class="form-text small mt-1">
                    El valor se toma de la configuraci√≥n global de pricing.
                  </div>
                </div>
              </div>
            </div>
          </div>

          {# 4) Notas (misma l√≥gica editable que GOODS) #}
          <hr>
          <div class="mb-2" style="min-width:260px;">
            <div class="label-soft mb-1">Notas</div>

            <div class="view-only small-muted" id="notes-view">
              {{ meta.notes or 'Sin notas' }}
            </div>

            <textarea id="txt-notes"
                      class="form-control form-control-sm edit-only d-none"
                      rows="2"
                      placeholder="Notas internas o comentarios...">{{ meta.notes or '' }}</textarea>
          </div>
        {% endif %}

      </div>
    </div>

    

    <!-- Historial de estados -->
    <div class="card shadow-sm mb-3">
      <div class="card-header">Historial de estado</div>
      <div class="card-body">
        {% if c.events and c.events|length %}
          <div class="timeline">
            {% for e in c.events %}
              <div class="timeline-item">
                <div class="timeline-state">
                  {{ e.prev_state or '‚Äî' }} ‚Üí {{ e.new_state }}
                </div>
                <div class="timeline-time">
                  {{ e.created_at.replace('T',' ')[:16] }} ¬∑ {{ e.actor or 'system' }}
                </div>
                {% if e.payload %}
                  <div class="small-muted">
                    {{ e.payload }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="small-muted">Sin eventos registrados todav√≠a.</div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Columna derecha -->
  <div class="col-lg-4">

    <!-- Adjuntos -->
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Adjuntos</span>
      </div>
      <div class="card-body">
        {% if c.attachments and c.attachments|length %}
          <ul class="list-unstyled mb-3" id="attachments-list">
            {% for a in c.attachments %}
              <li class="mb-2">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    {% if a.kind %}
                      <span class="chip-attachment-kind">{{ a.kind }}</span>
                    {% endif %}
                    <div class="small">
                      {% if a.url %}
                        <a href="{{ a.url }}" target="_blank" rel="noopener">
                          {{ a.key }}
                        </a>
                      {% else %}
                        {{ a.key }}
                      {% endif %}
                    </div>
                    <div class="small-muted">
                      {{ a.created_at.replace('T',' ')[:16] }}
                    </div>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="small-muted mb-2" id="attachments-empty">
            A√∫n no hay adjuntos.
          </div>
          <ul class="list-unstyled mb-3 d-none" id="attachments-list"></ul>
        {% endif %}

        <hr>
        <label class="form-label small">Subir nuevo adjunto</label>
        <input class="form-control form-control-sm" type="file" id="file" />
        <button class="btn btn-sm btn-secondary mt-2 w-100" id="btn-upload">
          Subir adjunto
        </button>
        <div id="up-out" class="small mt-2 text-muted"></div>
      </div>
    </div>

  </div>
</div>

<script>
const CASE_ID   = {{ c.id }};
const META      = {{ (c.meta or {})|tojson }};
const CASE_TYPE = META.kind || '{{ c.case_type or c.type }}' || 'GOODS';

let editMode     = false;
let pricingRules = {};  // { GOODS: {fee_pct, fee_flat}, REMIT: {...} }

const state = {
  case_type: CASE_TYPE,
  fee_mode: META.fee_mode || 'PCT',
  notes: META.notes || '',
  // GOODS
  items: (META.goods && META.goods.items) ? META.goods.items.map(it => ({
    description: it.description,
    qty: Number(it.qty || 0),
    cost_usd: Number(it.cost_usd || 0),
    price_usd: Number(it.price_usd || 0)
  })) : [],
  shipping: META.goods && META.goods.shipping ? {
    enabled: !!META.goods.shipping.enabled,
    amount: Number(META.goods.shipping.amount || 0),
    currency: META.goods.shipping.currency || 'USD'
  } : { enabled:false, amount:0, currency:'USD' },
  fx_rate_goods: META.fx && META.fx.rate != null ? Number(META.fx.rate) : null,
  fx_goods_date: META.fx && META.fx.date ? META.fx.date : null,
  fx_goods_pair: META.fx && META.fx.pair ? META.fx.pair : 'USD/PYG',

  // REMIT
  amount_usd: (META.remit && META.remit.amount_usd != null)
              ? Number(META.remit.amount_usd)
              : (META.amounts && META.amounts.base && META.amounts.base.usd != null
                  ? Number(META.amounts.base.usd)
                  : null),
  fx_rate: META.fx && META.fx.rate != null ? Number(META.fx.rate) : null,
  fx_date: META.fx && META.fx.date ? META.fx.date : null,
  fx_pair: META.fx && META.fx.pair ? META.fx.pair : null,
  remit_breakdown_py: META.amounts ? {
    base_py: META.amounts.base  ? Number(META.amounts.base.pyg  || 0) : 0,
    fee_py:  META.amounts.fee   ? Number(META.amounts.fee.pyg   || 0) : 0,
    total_py: META.amounts.total? Number(META.amounts.total.pyg || 0) : 0
  } : null,
  remit_fee_amount: META.amounts && META.amounts.fee ? Number(META.amounts.fee.usd || 0) : 0,
  remit_total_charge: META.amounts && META.amounts.total ? Number(META.amounts.total.usd || 0) : null
};

/* ===== Util ===== */
function toast(msg){
  if(window.showToast){ return window.showToast(msg); }
  alert(msg);
}
function formatGs(amount){
  const v = Math.round(Number(amount || 0));
  return 'Gs. ' + v.toLocaleString('es-PY');
}
function inferPairFromCountries(senderCountry, receiverCountry){
  if (senderCountry === 'US' && receiverCountry === 'PY') return 'USD/PYG';
  if (senderCountry === 'PY' && receiverCountry === 'US') return 'PYG/USD';
  return 'USD/PYG';
}

/* ========================================================= */
/* ======  PARTE 1: Cambiar estado + Adjuntos (igual)  ===== */
/* ========================================================= */

document.getElementById('btn-advance').onclick = async () => {
  const next = prompt('Estado/evento a aplicar (ej: ENVIADO_A_PY, LISTO_PARA_RETIRO, etc.)');
  if(!next) return;
  const r = await appPost(`/cases/${CASE_ID}/event`, { event: next });
  toast(JSON.stringify(r, null, 2));
  if(r.new_state){
    const lbl = document.getElementById('lbl-state');
    lbl.innerText = r.new_state;
    lbl.className = 'pill-state ' + r.new_state;
  }
};

document.getElementById('btn-upload').onclick = async () => {
  const f = document.getElementById('file').files[0];
  if(!f) return toast('Seleccion√° un archivo');
  try {
    const presign = await appPostRaw(`/api/cases/${CASE_ID}/attachments/presign`, {
      filename: f.name,
      content_type: f.type || 'application/octet-stream'
    });

    await fetch(presign.upload_url, {
      method:'PUT',
      headers: {'Content-Type': f.type || 'application/octet-stream'},
      body: f
    });

    const commit = await appPostRaw(`/api/cases/${CASE_ID}/attachments/commit`, {
      key: presign.final_key
    });

    document.getElementById('up-out').innerText =
      'Adjunto subido: ' + JSON.stringify(commit);

    toast('Adjunto subido ‚úî');
  } catch(err){
    console.error(err);
    toast('Error subiendo adjunto');
  }
};

/* ========================================================= */
/* ==========  PARTE 2: Pricing + Edici√≥n de meta  ========= */
/* ========================================================= */

/* ---- Cargar pricing desde /config/api/pricing ---- */
async function loadPricing(){
  try{
    const res = await fetch('/config/api/pricing');
    const txt = await res.text();
    let json; try{ json = JSON.parse(txt); } catch{ json = null; }

    if(!res.ok || !json || json.ok !== true){
      console.warn('pricing_get error', res.status, txt);
      return;
    }

    // Esperamos { ok: true, items: [ {case_type, fee_pct, fee_flat, ...}, ... ] }
    pricingRules = {};
    (json.items || []).forEach(r=>{
      pricingRules[r.case_type] = {
        fee_pct: Number(r.fee_pct || 0),
        fee_flat: Number(r.fee_flat || 0)
      };
    });

    updateFeeValueUI();
  }catch(e){
    console.warn('No se pudo cargar pricing:', e);
  }
}

/* ---- Actualizar UI de fee seg√∫n modo + pricing ---- */
function updateFeeValueUI(){
  const sel     = document.getElementById('sel-fee-mode');
  const inp     = document.getElementById('inp-fee-value');
  const lblUnit = document.getElementById('lbl-fee-unit');
  const feeView = document.getElementById('fee-view-label');

  const meta = META || {};
  const amts = meta.amounts || {};

  // Valores que vienen del pricing global (si ya se cargaron)
  const rulesRaw = pricingRules[CASE_TYPE] || {};
  let feePct  = (rulesRaw.fee_pct  != null) ? Number(rulesRaw.fee_pct)  : null;
  let feeFlat = (rulesRaw.fee_flat != null) ? Number(rulesRaw.fee_flat) : null;

  // Fallback: si no hay pricing cargado, tratamos de inferirlo del caso
  const baseUsdMeta = amts.base && amts.base.usd != null ? Number(amts.base.usd) : null;
  const feeUsdMeta  = amts.fee  && amts.fee.usd  != null ? Number(amts.fee.usd)  : null;

  if ((feePct == null || isNaN(feePct)) && baseUsdMeta && feeUsdMeta != null) {
    feePct = (feeUsdMeta * 100) / baseUsdMeta;
  }
  if ((feeFlat == null || isNaN(feeFlat)) && feeUsdMeta != null) {
    // Para "monto fijo", tomamos el fee en USD del caso
    feeFlat = feeUsdMeta;
  }

  const mode = state.fee_mode || 'PCT';

  if(sel){
    sel.value = mode;
  }

  if(inp && lblUnit){
    let showVal = 0;

    if(mode === 'PCT'){
      lblUnit.innerText = '%';
      showVal = feePct != null ? feePct : 0;
    } else if(mode === 'FIX'){
      lblUnit.innerText = 'USD';
      showVal = feeFlat != null ? feeFlat : 0;
    } else {
      // NONE
      lblUnit.innerText = '%';
      showVal = 0;
    }

    inp.value = Number(showVal).toFixed(2);
  }

  if(feeView){
    let text = 'Sin fee';

    if(mode === 'PCT'){
      const v = feePct != null ? feePct.toFixed(2) : '0.00';
      text = `Porcentaje (${v}%)`;
    } else if(mode === 'FIX'){
      const v = feeFlat != null ? feeFlat.toFixed(2) : '0.00';
      text = `Monto fijo (USD ${v})`;
    }

    feeView.innerHTML = 'Modo: <strong>' + mode + '</strong> ¬∑ ' + text;
  }
}


/* ---- Toggle edici√≥n ---- */
function setEditMode(on){
  editMode = on;
  document.querySelectorAll('.view-only').forEach(el=>{
    el.classList.toggle('d-none', on);
  });
  document.querySelectorAll('.edit-only').forEach(el=>{
    el.classList.toggle('d-none', !on);
  });

  const btn = document.getElementById('btn-save-meta');
  if(btn){
    btn.textContent = on ? 'üíæ Guardar cambios' : '‚úèÔ∏è Editar';
  }

  // Inicializar controles
  if(on){
    const notesInput = document.getElementById('txt-notes');
    if (notesInput) {
      // Cargar lo que tengamos en state
      notesInput.value = state.notes || '';
      // Mantener sincronizado mientras escribe
      notesInput.oninput = () => {
        state.notes = notesInput.value;
      };
    }

    const selFee = document.getElementById('sel-fee-mode');
    if(selFee){
      selFee.value = state.fee_mode;
      selFee.onchange = async ()=>{
        state.fee_mode = selFee.value;
        updateFeeValueUI();
        if(CASE_TYPE === 'GOODS'){
          syncGoodsItemsFromUI();
          await recalcPricesDetail();
        }else{
          await recalcRemitDetail();
        }
      };
    }

    if(CASE_TYPE === 'GOODS'){
      attachGoodsEditListeners();
    } else {
      attachRemitEditListeners();
    }
  }
}

/* ---- GOODS: leer inputs de la tabla ---- */
function syncGoodsItemsFromUI(){
  const tbody = document.getElementById('goods-items-body');
  if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  state.items = rows.map(row=>{
    const descEl = row.querySelector('.in-desc') || row.querySelector('.view-only');
    return {
      description: descEl ? descEl.value?.trim?.() || descEl.textContent.trim() : '',
      qty: Number((row.querySelector('.in-qty')  || {}).value || 0),
      cost_usd: Number((row.querySelector('.in-cost') || {}).value || 0),
      price_usd: Number((row.querySelector('.in-price')|| {}).value || 0)
    };
  }).filter(it => it.description);
}

/* ---- GOODS: recalcular v√≠a /cases/quote ---- */
async function recalcPricesDetail(){
  if(CASE_TYPE !== 'GOODS') return;
  if(!state.items.length) return;

  const itemsTotal = state.items.reduce(
    (acc, it)=> acc + (Number(it.cost_usd||0) * Number(it.qty||0)), 0
  );
  const shippingCost = state.shipping.enabled ? Number(state.shipping.amount || 0) : 0;

  // Sin fee -> costo + shipping
  if(state.fee_mode === 'NONE'){
    const totalCosto  = itemsTotal;
    const totalPrecio = totalCosto + shippingCost;
    const factor = totalCosto > 0 ? (totalPrecio / totalCosto) : 1;

    const tbody = document.getElementById('goods-items-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((row, i)=>{
      const costUnit = Number(row.querySelector('.in-cost').value || 0);
      const priceUnit = costUnit * factor;
      const inPrice = row.querySelector('.in-price');
      if(inPrice) inPrice.value = priceUnit.toFixed(2);
      state.items[i].price_usd = priceUnit;
    });

    updateGoodsTotals(totalCosto, totalPrecio, state.fx_rate_goods);
    return;
  }

  // Con fee -> proxy
  let feeType;
  if(state.fee_mode === 'PCT') feeType = 1;
  else if(state.fee_mode === 'FIX') feeType = 2;
  else feeType = 0;

  try{
    const res = await fetch('/cases/quote', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        kind: 'GOODS',
        customer_id: 1,
        items_total: itemsTotal,
        shipping_cost: shippingCost,
        fee_type: feeType
      })
    });

    const txt = await res.text();
    let json; try{ json = JSON.parse(txt); } catch{ json = null; }

    if(!res.ok){
      console.error('HTTP', res.status, txt);
      throw new Error('HTTP '+res.status);
    }

    const node = Array.isArray(json) ? json[0] : json;
    if(!node || node.ok !== true || !node.quote){
      console.error('Respuesta inesperada:', json);
      throw new Error('Formato de respuesta inv√°lido');
    }

    const quote = node.quote;
    const totalPrecio = Number(quote.total || 0);
    const totalCosto  = itemsTotal;
    const factor = totalCosto > 0 ? (totalPrecio / totalCosto) : 1;

    const tbody = document.getElementById('goods-items-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((row, i)=>{
      const costUnit  = Number(row.querySelector('.in-cost').value || 0);
      const priceUnit = costUnit * factor;
      const inPrice = row.querySelector('.in-price');
      if(inPrice) inPrice.value = priceUnit.toFixed(2);
      state.items[i].price_usd = priceUnit;
    });

    const fxObj = node.fx || quote.fx || META.fx || {};
    if(fxObj && fxObj.rate != null){
      state.fx_rate_goods = Number(fxObj.rate);
      state.fx_goods_date = fxObj.date || new Date().toISOString().slice(0,10);
      state.fx_goods_pair = fxObj.pair || 'USD/PYG';
    }

    updateGoodsTotals(totalCosto, totalPrecio, state.fx_rate_goods);
  }catch(e){
    console.error('recalcPricesDetail error:', e);
    toast('No se pudieron recalcular los precios');
  }
}

function updateGoodsTotals(totalCosto, totalPrecio, fxRate){
  fxRate = fxRate || 0;
  const diffUsd = totalPrecio - totalCosto;

  const baseUsdEl  = document.getElementById('tot-base-usd');
  const feeUsdEl   = document.getElementById('tot-fee-usd');
  const totalUsdEl = document.getElementById('tot-total-usd');
  const basePygEl  = document.getElementById('tot-base-pyg');
  const feePygEl   = document.getElementById('tot-fee-pyg');
  const totalPygEl = document.getElementById('tot-total-pyg');

  if(baseUsdEl)  baseUsdEl.innerText  = totalCosto.toFixed(2);
  if(feeUsdEl)   feeUsdEl.innerText   = diffUsd.toFixed(2);
  if(totalUsdEl) totalUsdEl.innerText = totalPrecio.toFixed(2);

  if(basePygEl)  basePygEl.innerText  = fxRate ? Math.round(totalCosto * fxRate).toLocaleString('es-PY') : '0';
  if(feePygEl)   feePygEl.innerText   = fxRate ? Math.round(diffUsd  * fxRate).toLocaleString('es-PY') : '0';
  if(totalPygEl) totalPygEl.innerText = fxRate ? Math.round(totalPrecio * fxRate).toLocaleString('es-PY') : '0';
}

/* ---- REMIT: recalcular v√≠a /cases/quote ---- */
async function recalcRemitDetail(){
  if(CASE_TYPE !== 'REMIT') return;
  if(!state.amount_usd || state.amount_usd <= 0) return;

  const senderCountry = (META.sender && META.sender.country) || 'US';
  const receiverCountry = (META.receiver && META.receiver.country) || 'PY';
  const pair = inferPairFromCountries(senderCountry, receiverCountry);

  let feeType, feeOverride = null;
  if (state.fee_mode === 'PCT') {
    feeType = 1;
  } else if (state.fee_mode === 'FIX') {
    feeType = 2;
  } else {
    feeType = 0;
    feeOverride = { fee_pct: 0, fee_flat: 0 };
  }

  try{
    const res = await fetch('/cases/quote', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        kind: 'REMIT',
        customer_id: 1,
        amount_usd: state.amount_usd,
        pair: pair,
        fee_type: feeType,
        fee_override: feeOverride
      })
    });

    const txt = await res.text();
    let json; try{ json = JSON.parse(txt); } catch{ json = null; }

    if(!res.ok){
      console.error('HTTP', res.status, txt);
      throw new Error('HTTP '+res.status);
    }

    const node = json;
    if(!node || node.ok !== true || !node.quote){
      console.error('Respuesta inesperada (REMIT):', json);
      throw new Error('Formato de respuesta inv√°lido');
    }

    const quote = node.quote;
    const fxObj   = quote.fx || node.fx || META.fx || {};
    const fxRate  = Number(fxObj.rate || quote.fx_rate || 0);
    const basePy  = Number(quote.base_py || 0);
    const feePy   = Number(quote.fee_amount || 0);
    const totalPy = Number(quote.total_py || 0);

    const baseUsd  = Number(state.amount_usd || 0);
    const feeUsd   = fxRate ? (feePy / fxRate) : 0;
    const totalUsd = baseUsd + feeUsd;

    state.fx_rate = fxRate || null;
    state.fx_date = fxObj.date || META.fx?.date || new Date().toISOString().slice(0,10);
    state.fx_pair = fxObj.pair || META.fx?.pair || pair;

    state.remit_fee_amount   = feeUsd;
    state.remit_total_charge = totalUsd;
    state.remit_breakdown_py = { base_py: basePy, fee_py: feePy, total_py: totalPy };

    updateRemitUIFromState();
  }catch(e){
    console.error('recalcRemitDetail error:', e);
    toast('No se pudo recalcular la remesa');
  }
}

function updateRemitUIFromState(){
  const viewAmt = document.getElementById('remit-amount-view');
  const basePyg = document.getElementById('remit-base-pyg');
  const feePyg  = document.getElementById('remit-fee-pyg');
  const totPyg  = document.getElementById('remit-total-pyg');
  const fxPair  = document.getElementById('remit-fx-pair');
  const fxDate  = document.getElementById('remit-fx-date');
  const fxRateEl= document.getElementById('remit-fx-rate');

  if(viewAmt) viewAmt.innerText = (state.amount_usd || 0).toFixed(2);
  if(basePyg) basePyg.innerText = state.remit_breakdown_py ? state.remit_breakdown_py.base_py.toLocaleString('es-PY') : '0';
  if(feePyg)  feePyg.innerText  = state.remit_breakdown_py ? state.remit_breakdown_py.fee_py.toLocaleString('es-PY') : '0';
  if(totPyg)  totPyg.innerText  = state.remit_breakdown_py ? state.remit_breakdown_py.total_py.toLocaleString('es-PY'): '0';
  if(fxPair && state.fx_pair) fxPair.innerText = state.fx_pair;
  if(fxDate && state.fx_date) fxDate.innerText = state.fx_date;
  if(fxRateEl && state.fx_rate!=null) fxRateEl.innerText = state.fx_rate.toFixed(0);
}

/* ---- Listeners espec√≠ficos de edici√≥n ---- */
function attachGoodsEditListeners(){
  const tbody = document.getElementById('goods-items-body');
  if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll('tr'));
  rows.forEach(row=>{
    const inQty  = row.querySelector('.in-qty');
    const inCost = row.querySelector('.in-cost');
    if(inQty){
      inQty.oninput = async ()=>{
        syncGoodsItemsFromUI();
        await recalcPricesDetail();
      };
    }
    if(inCost){
      inCost.oninput = async ()=>{
        syncGoodsItemsFromUI();
        await recalcPricesDetail();
      };
    }
  });
}

function attachRemitEditListeners(){
  const inAmt = document.getElementById('remit-amount-edit');
  if(inAmt){
    inAmt.oninput = async ()=>{
      const v = parseFloat(inAmt.value);
      state.amount_usd = isNaN(v) ? null : v;
      await recalcRemitDetail();
    };
  }
}

/* ---- Construir meta actualizado para PATCH ---- */
function buildUpdatedMeta(){
  const meta = JSON.parse(JSON.stringify(META || {}));
  meta.notes    = state.notes || null;
  meta.fee_mode = state.fee_mode;
  meta.kind     = state.case_type || meta.kind || CASE_TYPE;

  if(CASE_TYPE === 'GOODS'){
    let totalCostUsd = 0;
    let totalPriceUsd = 0;
    const items = (state.items || []).map(x=>{
      const qty   = Number(x.qty || 0);
      const cost  = Number(x.cost_usd || 0);
      const price = Number(x.price_usd || 0);
      totalCostUsd  += qty * cost;
      totalPriceUsd += qty * price;
      return { description:x.description, qty, cost_usd:cost, price_usd:price };
    });

    const diffUsd = totalPriceUsd - totalCostUsd;
    const fxRate  = state.fx_rate_goods || (meta.fx && meta.fx.rate) || null;
    const fxDate  = state.fx_goods_date || (meta.fx && meta.fx.date) || new Date().toISOString().slice(0,10);
    const fxPair  = state.fx_goods_pair || (meta.fx && meta.fx.pair) || 'USD/PYG';

    meta.fx = {date:fxDate, pair:fxPair, rate:fxRate};

    if(fxRate){
      meta.amounts = {
        base:  { usd: totalCostUsd,  pyg: totalCostUsd * fxRate },
        fee:   { usd: diffUsd,       pyg: diffUsd * fxRate },
        total: { usd: totalPriceUsd, pyg: totalPriceUsd * fxRate }
      };
    } else {
      meta.amounts = {
        base:  { usd: totalCostUsd,  pyg: 0 },
        fee:   { usd: diffUsd,       pyg: 0 },
        total: { usd: totalPriceUsd, pyg: 0 }
      };
    }

    meta.goods = meta.goods || {};
    meta.goods.items    = items;
    meta.remit          = null;

  } else {
    const baseUsd  = Number(state.amount_usd || 0);
    const feeUsd   = Number(state.remit_fee_amount || 0);
    const totalUsd = Number(state.remit_total_charge || (baseUsd + feeUsd));

    const fxRate  = state.fx_rate || (meta.fx && meta.fx.rate) || null;
    const fxDate  = state.fx_date || (meta.fx && meta.fx.date) || new Date().toISOString().slice(0,10);
    const fxPair  = state.fx_pair || (meta.fx && meta.fx.pair)
                     || inferPairFromCountries(
                          (META.sender && META.sender.country) || 'US',
                          (META.receiver && META.receiver.country) || 'PY'
                        );

    meta.fx = {date:fxDate, pair:fxPair, rate:fxRate};

    const bp = state.remit_breakdown_py || {};
    const basePy = bp.base_py || (fxRate ? baseUsd * fxRate : 0);
    const feePy  = bp.fee_py  || (fxRate ? feeUsd * fxRate  : 0);
    const totPy  = bp.total_py|| (fxRate ? totalUsd * fxRate: 0);

    meta.amounts = {
      base:  { usd: baseUsd,  pyg: basePy },
      fee:   { usd: feeUsd,   pyg: feePy  },
      total: { usd: totalUsd, pyg: totPy  }
    };

    meta.remit = meta.remit || {};
    meta.remit.amount_usd = baseUsd;
    if(!meta.remit.direction){
      const sc = (META.sender && META.sender.country) || 'US';
      const rc = (META.receiver && META.receiver.country) || 'PY';
      meta.remit.direction = `${sc}‚Üí${rc}`;
    }
    meta.goods = null;
  }

  return meta;
}

/* ---- Bot√≥n Editar / Guardar ---- */
const btnMeta = document.getElementById('btn-save-meta');
if(btnMeta){
  btnMeta.addEventListener('click', async ()=>{
    if(!editMode){
      setEditMode(true);
      return;
    }

    try{
      // 1) Sincronizar NOTAS desde el textarea
      const notesEl = document.getElementById('txt-notes');
      if (notesEl) {
        state.notes = notesEl.value.trim();
      }

      // 2) Recalcular seg√∫n el tipo de caso
      if(CASE_TYPE === 'GOODS'){
        syncGoodsItemsFromUI();
        await recalcPricesDetail();
      } else {
        const inAmt = document.getElementById('remit-amount-edit');
        if(inAmt){
          const v = parseFloat(inAmt.value);
          state.amount_usd = isNaN(v) ? null : v;
        }
        await recalcRemitDetail();
      }

      // 3) Construir meta con notes ya actualizadas
      const updatedMeta = buildUpdatedMeta();

      const res = await fetch(`/cases/${CASE_ID}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ meta: updatedMeta })
      });

      const txt = await res.text();
      let json; try{ json = JSON.parse(txt); } catch{ json=null; }

      if(!res.ok || !json || json.ok !== true){
        console.error('PATCH error', res.status, txt);
        toast('No se pudo guardar el caso');
        return;
      }

      toast('Cambios guardados ‚úî');
      setTimeout(()=> location.reload(), 600);
    }catch(e){
      console.error('save meta error', e);
      toast('Error guardando cambios');
    }
  });
}


/* ---- Init ---- */
loadPricing();
updateFeeValueUI();
</script>

{% endblock %}
