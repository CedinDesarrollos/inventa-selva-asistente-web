{% extends "base.html" %}
{% block content %}

<!-- Header superior: chips de estados -->
 <br>
<div class="page-header mb-2">
  <div class="page-actions ms-auto d-none d-sm-flex ">
    {% for k,v in por_estado.items() %}
      <span class="chip">
        <span
          class="dot"
          style="background:
            {% if 'venc' in k|lower %}#B91C1C
            {% elif 'pend' in k|lower %}#F59E0B
            {% elif 'ok' in k|lower or 'compl' in k|lower or 'done' in k|lower %}#16A34A
            {% else %}#9CA3AF{% endif %};"
        ></span>
        {{ k }}: {{ v }}
      </span>
    {% endfor %}
  </div>
</div>

<!-- KPIs -->
<div class="row g-3 mb-3">
  <!-- KPI 1: Total de casos -->
  <div class="col-12 col-md-4">
    <div class="card-kpi shadow-sm">
      <div class="card-kpi-header">
        <div class="card-kpi-icon">üìÅ</div>
        <div class="card-kpi-label">Total de casos</div>
      </div>
      <div class="card-kpi-value">
        {{ total }}
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div class="card-kpi-sub">Acumulado hist√≥rico</div>
      </div>
    </div>
  </div>

  <!-- KPI 2: SLA vencidos -->
  <div class="col-12 col-md-4">
    <div class="card-kpi shadow-sm">
      <div class="card-kpi-header">
        <div class="card-kpi-icon">‚è∞</div>
        <div class="card-kpi-label">SLA vencidos</div>
      </div>
      <div class="card-kpi-value">
        {{ sla }}
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div class="card-kpi-sub">Casos con SLA expirado</div>
      </div>
    </div>
  </div>

  <!-- KPI 3: Estados activos -->
  <div class="col-12 col-md-4">
    <div class="card-kpi shadow-sm">
      <div class="card-kpi-header">
        <div class="card-kpi-icon">üè∑Ô∏è</div>
        <div class="card-kpi-label">Estados activos</div>
      </div>
      <div class="card-kpi-value">
        {{ por_estado|length }}
      </div>
      <div class="card-kpi-sub">
        {% for k,v in por_estado.items() %}
          <span class="chip me-1 mb-1">{{ k }}: {{ v }}</span>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Encabezado de secci√≥n + bot√≥n -->
<div class="section-header-line mt-4 mb-1">
  <div class="section-header-main">
    <div class="section-eyebrow">
      <span class="section-pill"></span>
      √öltimos casos por tipo
    </div>
  </div>
  <div>
    <a href="/cases/new" class="btn btn-primary btn-sm btn-pill">
      + Nuevo
    </a>
  </div>
</div>
<br>


{% for tipo, lista in cases_by_type.items() %}
  {% set tipo_lower = tipo|lower %}
  {% set type_badge_color =
      'type-goods' if 'goods' in tipo_lower
      else 'type-remit' if 'remit' in tipo_lower
      else '' %}

  <div class="card card-table shadow-sm mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="chip {{ type_badge_color }}">
          {{ tipo }}
        </span>
        <span class="label-soft">({{ lista|length }} casos)</span>
      </div>
    </div>

    <div class="card-body table-responsive">
      <table class="table table-striped align-middle datatable" id="tbl-{{ loop.index }}">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>T√≠tulo</th>
            <th>Estado</th>
            <th>Actualizado</th>
          </tr>
        </thead>
        <tbody>
          {% if lista|length == 0 %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                Sin casos para este tipo
              </td>
            </tr>
          {% else %}
            {% for c in lista %}
              {% set state_norm = (c.state_lower or '') %}
              {% if 'venc' in state_norm or 'error' in state_norm or 'rech' in state_norm %}
                {% set badge_class = 'badge-status--error' %}
              {% elif 'pend' in state_norm %}
                {% set badge_class = 'badge-status--pendiente' %}
              {% elif 'ok' in state_norm or 'compl' in state_norm or 'done' in state_norm %}
                {% set badge_class = 'badge-status--ok' %}
              {% else %}
                {% set badge_class = 'badge-status--info' %}
              {% endif %}

              <tr>
                <td>
                  <a class="text-decoration-none fw-semibold" href="/cases/{{ c.id }}">
                    #{{ c.id }}
                  </a>
                </td>
                <td>{{ c.customer_nombre }}</td>
                <td class="col-title">{{ c.title }}</td>
                <td>
                  <span class="badge badge-status {{ badge_class }}">
                    {{ c.state }}
                  </span>
                </td>
                <td>
                  <span class="text-muted" data-order="{{ c.updated_at }}">
                    {{ c.updated_at_display }}
                  </span>
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
{% endfor %}

<script>
  // Inicializar DataTables en cada tabla de tipo
  document.querySelectorAll('table.datatable').forEach((tbl) => {
    new DataTable(tbl, {
      autoWidth: false,
      pageLength: 10,
      order: [[4, 'desc']],
      stateSave: true,
      responsive: false,
      scrollX: false,
      pagingType: 'simple',   // üëà solo ¬´Anterior¬ª y ¬´Siguiente¬ª
      layout: {
        topStart: 'pageLength',
        topEnd: 'search',
        bottomStart: 'info',
        bottomEnd: 'paging'
      },
      language: {
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_",
        info: "Mostrando _START_‚Äì_END_ de _TOTAL_",
        paginate: {
          previous: "‚Äπ Anterior",
          next: "Siguiente ‚Ä∫"
        },
        zeroRecords: "Sin resultados"
      }
    });
  });
</script>


{% endblock %}
